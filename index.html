<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- jQuery + Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
    <!-- JQuery Validation Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <style>
        #map {
            height: 400px;
            width: 100%;
            /* The width is the width of the div */
        }
    </style>
    <script>
        var latitude = 47.619144;
        var longitude = -122.281720;
        var uluru;
        var map;
        var marker;
        var geocoder;
        var infowindow;

        $('#main').submit(function () {
            return false;
        });

        $.validator.addMethod('latCoord', function (value, element) {
            console.log(this.optional(element))
            return this.optional(element) ||
                /^(?=.)-?((8[0-5]?)|([0-7]?[0-9]))?(?:\.[0-9]{1,20})?$/.test(value);
        }, 'Your Latitude format has error.')

        $.validator.addMethod('longCoord', function (value, element) {
            console.log(this.optional(element))
            return this.optional(element) ||
                /^(?=.)-?((0?[8-9][0-9])|180|([0-1]?[0-7]?[0-9]))?(?:\.[0-9]{1,20})?$/.test(value);
        }, 'Your Longitude format has error.')

        $.validator.setDefaults({
            highlight: function (element) {
                if (element.id == "lat") {
                    $(element).closest('.form-group').find(".form-control:first").addClass('is-invalid');
                } else {
                    $(element).closest('.form-group').find(".form-control:last").addClass('is-invalid');
                }
            },
            unhighlight: function (element) {
                if (element.id == "lat") {
                    $(element).closest('.form-group').find(".form-control:first").removeClass('is-invalid');
                    $(element).closest('.form-group').find(".form-control:first").addClass('is-valid');
                } else {
                    $(element).closest('.form-group').find(".form-control:last").removeClass('is-invalid');
                    $(element).closest('.form-group').find(".form-control:last").addClass('is-valid');
                }

            },
            errorElement: 'span',
            errorClass: 'invalid-feedback',
            errorPlacement: function (error, element) {
                if (element.parent('.input-group').length) {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element);
                }
            }
        });
        $(document).ready(function () {
            $('#mainform').validate({ // initialize the plugin
                rules: {
                    lat: {
                        required: true,
                        number: true,
                        latCoord: true
                    },
                    lon: {
                        required: true,
                        number: true,
                        longCoord: true
                    },

                },
            });

            $('#mainform input').on('keyup blur', function () {
                if ($('#mainform').valid()) {
                    $('button.btn-info').prop('disabled', false);
                } else {
                    $('button.btn-info').prop('disabled', 'disabled');
                }
            });

            // when dragend, show new lat and lon in console
            google.maps.event.addListener(marker, 'dragend', function () {
                uluru = marker.getPosition();

                geocoder.geocode({ location: uluru }, (results, status) => {
                    if (status === "OK") {
                        if (results[0]) {
                            map.setZoom(11);
                            console.log(results[0].formatted_address);
                            infowindow.setContent(results[0].formatted_address);
                            infowindow.open(map, marker);
                        } else {
                            window.alert("No results found");
                        }
                    } else {
                        window.alert("Geocoder API failed due to: " + status);
                    }
                });
                document.getElementById("lat").value = marker.position.lat();
                document.getElementById("lon").value = marker.position.lng();
                console.log("lat: " + marker.position.lat());
                console.log("lng: " + marker.position.lng());
            });
            google.maps.event.addDomListener(window, 'load', initMap(latitude, longitude));

            google.maps.event.addListener(map, 'click', function (event) {
                newLocation(event.myCenter);
            });

            // Zoom to 10 when clicking on marker
            google.maps.event.addListener(marker, 'click', function () {
                map.setZoom(10);
                map.setCenter(marker.getPosition());

            });

        });
    </script>
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD51Uv_89ZJVOIJICOiah4YI3guPpgVZDA&callback=initMap">
        </script>

</head>

<body>

    <script>

        // Initialize and add the map
        function initMap() {
            // The location of Uluru
            uluru = { lat: latitude, lng: longitude };

            var mapOptions = {
                center: uluru,
                zoom: 12,
                controlSize: 24,
                streetViewControl: false,
                fullscreenControl: false,
            };
            // The map, centered at Uluru
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            marker = new google.maps.Marker({
                position: uluru,
                map: map,
                draggable: true, // set marker draggable
            });
            marker.setMap(map);

            geocoder = new google.maps.Geocoder();
            infowindow = new google.maps.InfoWindow();
            geocoder.geocode({ location: uluru }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        map.setZoom(14);
                        console.log(results[0].formatted_address);
                        infowindow.setContent("Drag me!");
                        infowindow.open(map, marker);
                    } else {
                        window.alert("No results found");
                    }
                } else {
                    window.alert("Geocoder API failed due to: " + status);
                }
            });
        }

        function newLocation(newLat, newLng) {
            uluru.lat = newLat;
            uluru.lng = newLng;
            map.setCenter({
                lat: newLat,
                lng: newLng
            });
        }


        function myFunction() {
            latitude = parseFloat(document.getElementById("lat").value);
            longitude = parseFloat(document.getElementById("lon").value);
            document.getElementById("lat").value = latitude;
            document.getElementById("lon").value = longitude;
            uluru.lat = latitude;
            uluru.lng = longitude;
            map.setCenter({
                lat: latitude,
                lng: longitude
            });
            marker.setMap(null);
            marker = new google.maps.Marker({
                position: uluru,
                map: map,
                draggable: true,
                title: "Drag me!"
            });
            marker.setMap(map);
            geocoder.geocode({ location: uluru }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        map.setZoom(11);
                        console.log(results[0].formatted_address);
                        infowindow.setContent(results[0].formatted_address);
                        marker.title = results[0].formatted_address;
                        infowindow.open(map, marker);
                    } else {
                        window.alert("No results found");
                    }
                } else {
                    window.alert("Geocoder API failed due to: " + status);
                }
            });
            document.getElementById("lat").value = marker.position.lat();
            document.getElementById("lon").value = marker.position.lng();

        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                alert("Geolocation is not supported/enabled by this browser.");
            }
        }

        function showPosition(position) {
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
            document.getElementById("lat").value = latitude;
            document.getElementById("lon").value = longitude;
            map.setCenter({
                lat: latitude,
                lng: longitude
            });
            uluru.lat = latitude;
            uluru.lng = longitude;
            console.log(uluru.lat);
            marker.setMap(null);
            marker = new google.maps.Marker({
                position: uluru,
                map: map,
                draggable: true,
                title: "Drag me!"
            });
            marker.setMap(map);
            geocoder.geocode({ location: uluru }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        map.setZoom(14);
                        console.log(results[0].formatted_address);
                        infowindow.setContent("Drag me!");
                        infowindow.open(map, marker);
                    } else {
                        window.alert("No results found");
                    }
                } else {
                    window.alert("Geocoder API failed due to: " + status);
                }
            });
            console.log(marker.position.lat);
        }
    </script>
    <div class="container mt-5" style="max-width: 800px">

        <h3 class="text-center mb-5">Fun with Google Maps</h3>
        <div id="map"></div>
        <form id="mainform" onsubmit="return false">
            <div class="form-group">
                <br>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Latitude &nbsp&nbsp</span>
                    </div>
                    <input class="form-control" id="lat" name="lat" placeholder="e.g. 47.619144" value="47.619144">
                </div>
                <br>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Longitude</span>
                    </div>
                    <input class="form-control" id="lon" name="lon" placeholder="e.g. -122.281720" value="-122.281720">
                </div>
                <br>
                <br>
                <div class="btn-toolbar justify-content-around" role="toolbar">
                    <div class="btn-group mr-2" role="group" aria-label="First group">
                        <button onclick="myFunction()" class="btn btn-info" name="send" id="send" disabled><i
                                class="fas fa-map-marked-alt"> Pin</i></button>
                    </div>
                    <div class="btn-group mr-2" role="group" aria-label="Second group">
                        <button onclick="getLocation()" class="btn btn-primary btn-success" name="geolocation"
                            id="geolocation"><i class="fas fa-map-marker-alt"> Geolocation</i></button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</body>

</html>